{"ast":null,"code":"import{useEffect}from'react';import{useDispatch,useSelector}from'react-redux';import{useActiveWeb3React}from'../../hooks';import{useAddPopup,useBlockNumber}from'../application/hooks';import{checkedTransaction,finalizeTransaction}from'./actions';export function shouldCheck(lastBlockNumber,tx){if(tx.receipt)return false;if(!tx.lastCheckedBlockNumber)return true;const blocksSinceCheck=lastBlockNumber-tx.lastCheckedBlockNumber;if(blocksSinceCheck<1)return false;const minutesPending=(new Date().getTime()-tx.addedTime)/1000/60;if(minutesPending>60){// every 10 blocks if pending for longer than an hour\nreturn blocksSinceCheck>9;}else if(minutesPending>5){// every 3 blocks if pending more than 5 minutes\nreturn blocksSinceCheck>2;}else{// otherwise every block\nreturn true;}}export default function Updater(){var _state$chainId;const{chainId,library}=useActiveWeb3React();const lastBlockNumber=useBlockNumber();const dispatch=useDispatch();const state=useSelector(state=>state.transactions);const transactions=chainId?(_state$chainId=state[chainId])!==null&&_state$chainId!==void 0?_state$chainId:{}:{};// show popup on confirm\nconst addPopup=useAddPopup();useEffect(()=>{if(!chainId||!library||!lastBlockNumber)return;Object.keys(transactions).filter(hash=>shouldCheck(lastBlockNumber,transactions[hash])).forEach(hash=>{library.getTransactionReceipt(hash).then(receipt=>{if(receipt){var _transactions$hash;dispatch(finalizeTransaction({chainId,hash,receipt:{blockHash:receipt.blockHash,blockNumber:receipt.blockNumber,contractAddress:receipt.contractAddress,from:receipt.from,status:receipt.status,to:receipt.to,transactionHash:receipt.transactionHash,transactionIndex:receipt.transactionIndex}}));addPopup({txn:{hash,success:receipt.status===1,summary:(_transactions$hash=transactions[hash])===null||_transactions$hash===void 0?void 0:_transactions$hash.summary}},hash);}else{dispatch(checkedTransaction({chainId,hash,blockNumber:lastBlockNumber}));}}).catch(error=>{console.error(\"failed to check transaction hash: \".concat(hash),error);});});},[chainId,library,transactions,lastBlockNumber,dispatch,addPopup]);return null;}","map":{"version":3,"names":["useEffect","useDispatch","useSelector","useActiveWeb3React","useAddPopup","useBlockNumber","checkedTransaction","finalizeTransaction","shouldCheck","lastBlockNumber","tx","receipt","lastCheckedBlockNumber","blocksSinceCheck","minutesPending","Date","getTime","addedTime","Updater","_state$chainId","chainId","library","dispatch","state","transactions","addPopup","Object","keys","filter","hash","forEach","getTransactionReceipt","then","_transactions$hash","blockHash","blockNumber","contractAddress","from","status","to","transactionHash","transactionIndex","txn","success","summary","catch","error","console","concat"],"sources":["/Users/synallage/Desktop/fomoswap-uni/interface-73580de922ce3ff642430d71aa24f5c053e6dd4d/src/state/transactions/updater.tsx"],"sourcesContent":["import { useEffect } from 'react'\nimport { useDispatch, useSelector } from 'react-redux'\nimport { useActiveWeb3React } from '../../hooks'\nimport { useAddPopup, useBlockNumber } from '../application/hooks'\nimport { AppDispatch, AppState } from '../index'\nimport { checkedTransaction, finalizeTransaction } from './actions'\n\nexport function shouldCheck(\n  lastBlockNumber: number,\n  tx: { addedTime: number; receipt?: {}; lastCheckedBlockNumber?: number }\n): boolean {\n  if (tx.receipt) return false\n  if (!tx.lastCheckedBlockNumber) return true\n  const blocksSinceCheck = lastBlockNumber - tx.lastCheckedBlockNumber\n  if (blocksSinceCheck < 1) return false\n  const minutesPending = (new Date().getTime() - tx.addedTime) / 1000 / 60\n  if (minutesPending > 60) {\n    // every 10 blocks if pending for longer than an hour\n    return blocksSinceCheck > 9\n  } else if (minutesPending > 5) {\n    // every 3 blocks if pending more than 5 minutes\n    return blocksSinceCheck > 2\n  } else {\n    // otherwise every block\n    return true\n  }\n}\n\nexport default function Updater() {\n  const { chainId, library } = useActiveWeb3React()\n\n  const lastBlockNumber = useBlockNumber()\n\n  const dispatch = useDispatch<AppDispatch>()\n  const state = useSelector<AppState, AppState['transactions']>(state => state.transactions)\n\n  const transactions = chainId ? state[chainId] ?? {} : {}\n\n  // show popup on confirm\n  const addPopup = useAddPopup()\n\n  useEffect(() => {\n    if (!chainId || !library || !lastBlockNumber) return\n\n    Object.keys(transactions)\n      .filter(hash => shouldCheck(lastBlockNumber, transactions[hash]))\n      .forEach(hash => {\n        library\n          .getTransactionReceipt(hash)\n          .then(receipt => {\n            if (receipt) {\n              dispatch(\n                finalizeTransaction({\n                  chainId,\n                  hash,\n                  receipt: {\n                    blockHash: receipt.blockHash,\n                    blockNumber: receipt.blockNumber,\n                    contractAddress: receipt.contractAddress,\n                    from: receipt.from,\n                    status: receipt.status,\n                    to: receipt.to,\n                    transactionHash: receipt.transactionHash,\n                    transactionIndex: receipt.transactionIndex\n                  }\n                })\n              )\n\n              addPopup(\n                {\n                  txn: {\n                    hash,\n                    success: receipt.status === 1,\n                    summary: transactions[hash]?.summary\n                  }\n                },\n                hash\n              )\n            } else {\n              dispatch(checkedTransaction({ chainId, hash, blockNumber: lastBlockNumber }))\n            }\n          })\n          .catch(error => {\n            console.error(`failed to check transaction hash: ${hash}`, error)\n          })\n      })\n  }, [chainId, library, transactions, lastBlockNumber, dispatch, addPopup])\n\n  return null\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}